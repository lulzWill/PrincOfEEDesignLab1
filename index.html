<html>
	<head>
		<meta charset="utf-8">
   	 	<meta http-equiv="X-UA-Compatible" content="IE=edge">
   	 	<meta name="viewport" content="width=device-width, initial-scale=1">
		<link href="flot/examples/shared/jquery-ui/jquery-ui.min.css" rel="stylesheet" type="text/css">
		<title>Temperature View</title>
		<script language="javascript" type="text/javascript" src="flot/jquery.js"></script>
		<script language="javascript" type="text/javascript" src="flot/jquery.flot.js"></script>
		<script language="javascript" type="text/javascript" src="flot/examples/shared/jquery-ui/jquery-ui.min.js"></script>
		<script language="javascript" type="text/javascript" src="flot/jquery.flot.resize.js"></script>
		<script src="//www.parsecdn.com/js/parse-1.5.0.min.js"></script>
		<link href="flot/examples/examples.css" rel="stylesheet" type="text/css">
		<!-- Bootstrap -->
	    <link href="css/bootstrap.min.css" rel="stylesheet">

	    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
	    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	    <!--[if lt IE 9]>
	      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	    <![endif]-->
	    <input type="text" hidden="true" value="C" id="tempType"></input>
	    <input type="text" hidden="true" value="" id="tempVal"></input>

		<script type="text/javascript">
			function setC() {
				document.getElementById("tempType").value = "C";
				document.getElementById("btnC").disabled = true;
				document.getElementById("btnF").disabled = false;
				document.getElementById("currTemp").innerHTML = "Current Temperature: " + document.getElementById("tempVal").value +"°C";
			}

			function setF() {
				document.getElementById("tempType").value = "F";
				document.getElementById("btnC").disabled = false;
				document.getElementById("btnF").disabled = true;

				var convertedTemp = document.getElementById("tempVal").value;
				convertedTemp = ((9/5)*convertedTemp) + 32;
				
				document.getElementById("currTemp").innerHTML = "Current Temperature: " + convertedTemp +"°F";
			}

			function setOn() {
					document.getElementById("btnOn").disabled = true;

					if(document.getElementById("tempType").value == "C") {
						document.getElementById("currTemp").innerHTML = "Current Temperature: " + document.getElementById("tempVal").value +"°C";
						
						document.getElementById("btnC").disabled = true;
						document.getElementById("btnF").disabled = false;
					} else {
						var convertedTemp = document.getElementById("tempVal").value;
						convertedTemp = ((9/5)*convertedTemp) + 32;
	
						document.getElementById("currTemp").innerHTML = "Current Temperature: " + convertedTemp +"°F";
						document.getElementById("btnC").disabled = false;
						document.getElementById("btnF").disabled = true;
					}

					Parse.initialize("DgkajZ46p0LCwrwpfUFmbCeGoIizgVbo6z4LUEhP", "e1AtOMGA0JWTl9Uko5bWiCyP8a5Edo4K0hKDvXxK");
					var MachineMetadata = Parse.Object.extend("MachineMetadata");
					var query = new Parse.Query(MachineMetadata);

					query.equalTo("deviceName", "Temp Sensor");

					query.first({
						success: function(object) {
							object.set("isOn", "true");
							object.save();
							document.getElementById("btnOff").disabled = false;
						},
						error: function(error) {
							alert("Error: " + error.code + " " + error.message);
						}
					});
			}

			function setOff() {
					document.getElementById("btnOff").disabled = true;
					document.getElementById("currTemp").innerHTML = "Device is Off";

					document.getElementById("btnC").disabled = true;
					document.getElementById("btnF").disabled = true;

					Parse.initialize("DgkajZ46p0LCwrwpfUFmbCeGoIizgVbo6z4LUEhP", "e1AtOMGA0JWTl9Uko5bWiCyP8a5Edo4K0hKDvXxK");
					var MachineMetadata = Parse.Object.extend("MachineMetadata");
					var query = new Parse.Query(MachineMetadata);

					query.equalTo("deviceName", "Temp Sensor");

					query.first({
						success: function(object) {
							object.set("isOn", "false");
							object.save();
							document.getElementById("btnOn").disabled = false;
						},
						error: function(error) {
							alert("Error: " + error.code + " " + error.message);
						}
					});
			}

			$(function() {
				var data = [], totalPoints = 300;

				for(var i = 0; i < totalPoints; i++) {
					data.push(null);
				}

				function getDataPoints() {
					Parse.initialize("DgkajZ46p0LCwrwpfUFmbCeGoIizgVbo6z4LUEhP", "e1AtOMGA0JWTl9Uko5bWiCyP8a5Edo4K0hKDvXxK");
					if(data.length > 0) data = data.slice(1);
					
					var MachineMetadata = Parse.Object.extend("MachineMetadata");
					var queryTop = new Parse.Query(MachineMetadata);

					queryTop.equalTo("deviceName", "Temp Sensor");

					queryTop.first({
						success: function(object) {
							if(object.get("isOn") == "true" && !object.get("isUnplugged")) {
								var TempData = Parse.Object.extend("TempData");
								var query = new Parse.Query(TempData);

								query.descending("updatedAt");
								query.first({
									success: function(object) {
										data.push(object.get("TempValue"));
										if(document.getElementById("tempType").value == "C") {
											document.getElementById("currTemp").innerHTML = "Current Temperature: " + object.get("TempValue") +"°C";
										} else {
											var convertedTemp = object.get("TempValue");
											convertedTemp = ((9/5)*convertedTemp) + 32;
	
											document.getElementById("currTemp").innerHTML = "Current Temperature: " + convertedTemp +"°F";
										}

										document.getElementById("tempVal").value = object.get("TempValue");
										document.getElementById("btnOff").disabled = false;
										document.getElementById("btnOn").disabled = true;
									},
									error: function(error) {
										alert("Error: " + error.code + " " + error.message);
									}
								});
							} else if(!object.get("isUnplugged")){
								data.push(null);
								document.getElementById("currTemp").innerHTML = "Device is Off";
								document.getElementById("btnOff").disabled = true;
								document.getElementById("btnOn").disabled = false;
							} else {
								data.push(null);
								document.getElementById("currTemp").innerHTML = "Device Unplugged";
								document.getElementById("btnOff").disabled = true;
								document.getElementById("btnOn").disabled = true;
							}
						},
						error: function(error) {
							alert("Error: " + error.code + " " + error.message);
						}
					});
					
					
					var res = [];
					for(var i = 0; i < data.length; ++i) {
						res.push([i, data[i]])
					}

					return res;
				}
				var updateInterval = 1000;

				var plot = $.plot("#placeholder", [ getDataPoints() ], {
					series: {
						shadowSize: 0
					},
					yaxis: {
						min: 10,
						max: 50
					},
					xaxis: {
						min: 0,
						max: 299,
						ticks: [[0, "300"], [50, "250"],[100, "200"],[150, "150"], [200, "100"], [250, "50"], [299, "0"]]
					}
				});

				function update() {
					plot.setData([getDataPoints()]);

					plot.draw();
					setTimeout(update, updateInterval);
				}

				update();

				$(".demo-container").resizable({
				});
			});
		</script>
	</head>
	<body>
		<div id="header">
			<h2>Temperature Graph</h2>
		</div>
		<div id="content">
			<div class="demo-container">
				<div id="placeholder" class="demo-placeholder"></div>
			</div>
		</div>
		<div id="footer">
			<h2 id="currTemp">Current Temperature: </h2>
			<div class="btn-group" role="group" aria-label="...">
			  <button type="button" class="btn btn-success" id="btnC" onClick="setC()" disabled="true">°C</button>
			  <button type="button" class="btn btn-danger" id="btnF" onClick="setF()">°F</button>
			</div>
			<div class="btn-group" role="group" aria-label="...">
			  <button type="button" class="btn btn-success" id="btnOn" onClick="setOn()">On</button>
			  <button type="button" class="btn btn-danger" id="btnOff" onClick="setOff()">Off</button>
			</div>
		</div>
	</body>
</html>